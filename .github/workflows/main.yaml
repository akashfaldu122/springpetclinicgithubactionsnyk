name: Snyk Full Security Scan

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read
  security-events: write

jobs:
  snyk-full-scan:
    runs-on: ubuntu-latest
    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Authenticate Snyk
        run: snyk auth $SNYK_TOKEN

      # --------------------
      # Run Snyk for all projects and produce SARIF
      # --------------------
      - name: Run Snyk test for all projects (SARIF)
        run: snyk test --all-projects --sarif-file-output=snyk-all.sarif || true

      # --------------------
      # Split SARIF file into individual runs
      # --------------------
      - name: Split Snyk SARIF into individual files
        run: |
          mkdir -p snyk-sarif
          total=$(jq '.runs | length' snyk-all.sarif)
          for i in $(seq 0 $((total-1))); do
            jq ".runs[$i]" snyk-all.sarif > "snyk-sarif/run-$i.json"
            # wrap in SARIF schema
            jq -n --argjson run "$(cat snyk-sarif/run-$i.json)" '{version: "2.1.0", runs: [$run]}' > "snyk-sarif/run-$i.sarif"
          done

      # --------------------
      # Upload each SARIF run separately
      # --------------------
      - name: Upload all Snyk SARIF files
        run: |
          for file in snyk-sarif/*.sarif; do
            gh codeql upload-sarif "$file" || true
          done


      # --------------------
      # Monitor projects in Snyk
      # --------------------
      - name: Monitor all projects in Snyk
        run: snyk monitor --all-projects || true

      # --------------------
      # Snyk Code Scan (SAST)
      # --------------------
      - name: Snyk Code Scan
        run: snyk code test --sarif-file-output=snyk-code.sarif || true

      - name: Upload Snyk Code SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-code.sarif

      - name: Monitor Snyk Code
        run: snyk code monitor || true
